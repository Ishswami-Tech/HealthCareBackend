# Custom Metrics API Configuration
# Required for custom HPA metrics like http_requests_per_second
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: custom-metrics-apiserver
  namespace: healthcare-backend
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: custom-metrics-server-resources
rules:
- apiGroups:
  - custom.metrics.k8s.io
  resources:
  - "*"
  verbs:
  - "*"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: custom-metrics-resource-reader
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: custom-metrics-server-resources
subjects:
- kind: ServiceAccount
  name: custom-metrics-apiserver
  namespace: healthcare-backend
---
# ServiceMonitor for Prometheus metrics collection
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: healthcare-api-monitor
  namespace: healthcare-backend
  labels:
    app: healthcare-api
spec:
  selector:
    matchLabels:
      app: healthcare-api
  endpoints:
  - port: http
    path: /metrics
    interval: 30s
    scrapeTimeout: 10s
---
# PrometheusRule for custom metrics
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: healthcare-api-rules
  namespace: healthcare-backend
spec:
  groups:
  - name: healthcare-api
    interval: 30s
    rules:
    # HTTP Requests per second metric
    - record: http_requests_per_second
      expr: |
        rate(http_requests_total{job="healthcare-api"}[1m])

    # Active appointments count
    - record: active_appointments_count
      expr: |
        appointments_active_total{job="healthcare-api"}

    # Database connection pool usage
    - record: db_connection_pool_usage
      expr: |
        (db_connections_active / db_connections_max) * 100

    # Queue depth for background jobs
    - record: queue_depth
      expr: |
        bull_queue_waiting_total + bull_queue_active_total
---
# Example: Prometheus Adapter ConfigMap (if using prometheus-adapter)
apiVersion: v1
kind: ConfigMap
metadata:
  name: adapter-config
  namespace: healthcare-backend
data:
  config.yaml: |
    rules:
    - seriesQuery: 'http_requests_total{namespace="healthcare-backend"}'
      resources:
        overrides:
          namespace: {resource: "namespace"}
          pod: {resource: "pod"}
      name:
        matches: "^http_requests_total"
        as: "http_requests_per_second"
      metricsQuery: 'rate(http_requests_total{<<.LabelMatchers>>}[1m])'

    - seriesQuery: 'appointments_active_total{namespace="healthcare-backend"}'
      resources:
        overrides:
          namespace: {resource: "namespace"}
          pod: {resource: "pod"}
      name:
        matches: "^appointments_active_total"
        as: "active_appointments_count"
      metricsQuery: 'appointments_active_total{<<.LabelMatchers>>}'
