# Quick Start Development Environment
# Run with: docker-compose -f devops/docker/docker-compose.dev.yml up -d
# Access: http://localhost:8088

services:
  api:
    build:
      context: ../..
      dockerfile: devops/docker/Dockerfile.dev
    container_name: healthcare-api
    ports:
      - "8088:8088"
      - "5555:5555"
    environment:
      # Application Environment
      NODE_ENV: development
      PORT: 8088
      HOST: 0.0.0.0
      BIND_ADDRESS: 0.0.0.0
      DOCKER_ENV: "true"
      SERVICE_NAME: api
      
      # Database Configuration
      # Connection pool parameters: connection_limit=50, pool_timeout=20
      # Increased for 10M+ users scalability and to prevent connection pool exhaustion
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/userdb?connection_limit=50&pool_timeout=20
      # DIRECT_URL: Clean connection string for Prisma Studio (without Prisma-specific parameters)
      # Prisma Studio needs this to connect properly without "unrecognized configuration parameter" errors
      DIRECT_URL: postgresql://postgres:postgres@postgres:5432/userdb
      PRISMA_SCHEMA_PATH: /app/src/libs/infrastructure/database/prisma/schema.prisma
      
      # Cache Provider Configuration (Dragonfly is default)
      CACHE_ENABLED: "true"
      CACHE_PROVIDER: dragonfly
      
      # Redis Configuration (for Redis provider) - Commented out, using Dragonfly
      # REDIS_HOST: redis
      # REDIS_PORT: 6379
      # REDIS_DB: 0
      # REDIS_TTL: 3600
      # REDIS_PREFIX: "healthcare:"
      # REDIS_ENABLED: "true"
      
      # Dragonfly Configuration (default provider - using instead of Redis)
      DRAGONFLY_ENABLED: "true"
      DRAGONFLY_HOST: dragonfly
      DRAGONFLY_PORT: 6379
      DRAGONFLY_KEY_PREFIX: "healthcare:"
      
      # JWT Configuration
      JWT_SECRET: dev-jwt-secret-key-change-in-production
      JWT_EXPIRATION: 24h
      JWT_ACCESS_EXPIRES_IN: 24h
      JWT_REFRESH_EXPIRES_IN: 7d
      
      # Session Configuration (Fastify Session with CacheService/Dragonfly)
      SESSION_SECRET: dev-session-secret-change-in-production-min-32-chars-long
      SESSION_TIMEOUT: 86400
      SESSION_SECURE_COOKIES: "false"
      SESSION_SAME_SITE: "lax"
      COOKIE_SECRET: dev-cookie-secret-change-in-production-min-32-chars
      
      # Base URLs
      BASE_URL: http://localhost:8088
      API_URL: http://localhost:8088
      FRONTEND_URL: http://localhost:3000
      
      # CORS Configuration
      CORS_ORIGIN: http://localhost:3000,http://localhost:8088,http://localhost:5050,http://localhost:8082,http://localhost:8443
      CORS_CREDENTIALS: "true"
      
      # Service URLs
      SWAGGER_URL: /docs
      BULL_BOARD_URL: /queue-dashboard
      SOCKET_URL: /socket.io
      REDIS_COMMANDER_URL: http://localhost:8082
      PRISMA_STUDIO_URL: http://localhost:5555
      PGADMIN_URL: http://localhost:5050
      
      # Jitsi Meet Configuration (Self-hosted) - Loaded from .env files
      JITSI_DOMAIN: ${JITSI_DOMAIN:-localhost:8443}
      JITSI_BASE_DOMAIN: ${JITSI_BASE_DOMAIN:-localhost}
      JITSI_SUBDOMAIN: ${JITSI_SUBDOMAIN:-localhost}
      JITSI_APP_ID: ${JITSI_APP_ID:-healthcare-jitsi-app}
      JITSI_APP_SECRET: ${JITSI_APP_SECRET:-dev-jitsi-secret-change-in-production}
      JITSI_BASE_URL: ${JITSI_BASE_URL:-https://localhost:8443}
      JITSI_WS_URL: ${JITSI_WS_URL:-wss://localhost:8443/xmpp-websocket}
      VIDEO_ENABLED: ${VIDEO_ENABLED:-true}
      JITSI_ENABLE_RECORDING: ${JITSI_ENABLE_RECORDING:-true}
      JITSI_ENABLE_WAITING_ROOM: ${JITSI_ENABLE_WAITING_ROOM:-true}
      
      # Google OAuth Configuration
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: http://localhost:8088/auth/google/callback
      
      # API Configuration
      API_PREFIX: /api/v1
      
      # Logging Configuration
      LOG_LEVEL: debug
      ENABLE_AUDIT_LOGS: "true"
      
      # Security Configuration
      SECURITY_RATE_LIMIT: "true"
      SECURITY_RATE_LIMIT_MAX: 1000
      SECURITY_RATE_LIMIT_WINDOW_MS: 15000
      TRUST_PROXY: 1
      
      # Rate Limiting
      RATE_LIMIT_TTL: 60
      RATE_LIMIT_MAX: 100
      
      # Email Configuration (Optional - using defaults)
      EMAIL_HOST: sandbox.smtp.mailtrap.io
      EMAIL_PORT: 2525
      EMAIL_SECURE: "false"
      EMAIL_FROM: noreply@healthcare.com
      
      # Development Tools
      ENABLE_SWAGGER: "true"
      ENABLE_PRISMA_STUDIO: "true"
    volumes:
      - ../../:/app
      - /app/node_modules
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
      # redis:
      #   condition: service_healthy
    networks:
      - healthcare-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8088/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        until pg_isready -h postgres -p 5432 -U postgres; do
          echo 'Waiting for postgres...'
          sleep 2
        done &&
        echo 'Database is ready!' &&
        echo 'Generating Prisma Client...' &&
        pnpm prisma generate --schema=./src/libs/infrastructure/database/prisma/schema.prisma || echo 'Prisma generate completed' &&
        echo 'Fixing Prisma types...' &&
        (pnpm exec ts-node -r tsconfig-paths/register scripts/fix-prisma-types.ts || echo 'Fix script completed') &&
        echo 'Running Prisma Database Sync (Development Mode)...' &&
        echo 'Using db push for development (no migration history required)...' &&
        pnpm prisma:db:push || echo 'Database push completed or skipped' &&
        echo 'Starting application...' &&
        pnpm start:dev
      "

  postgres:
    image: postgres:16-alpine
    container_name: healthcare-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: userdb
    command: >
      postgres
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_worker_processes=4
      -c max_parallel_workers_per_gather=2
      -c max_parallel_workers=4
      -c max_parallel_maintenance_workers=2
      -c idle_in_transaction_session_timeout=30000
      -c statement_timeout=30000
      -c lock_timeout=10000
      -c listen_addresses='*'
      -c log_connections=on
      -c log_disconnections=on
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - healthcare-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    container_name: healthcare-dragonfly
    ports:
      - "6380:6379"
    command: >
      --alsologtostderr
      --cache_mode=false
      --maxmemory=2gb
      --proactor_threads=4
      --default_lua_flags=allow-undeclared-keys
    volumes:
      - dragonfly_data:/data
    networks:
      - healthcare-network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -p 6379 ping || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # Redis - Commented out, using Dragonfly instead
  # redis:
  #   image: redis:7-alpine
  #   container_name: healthcare-redis
  #   ports:
  #     - "6379:6379"
  #   command: redis-server --appendonly yes
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - healthcare-network
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5
  #   restart: unless-stopped

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: healthcare-redis-ui
    ports:
      - "8082:8081"
    environment:
      - REDIS_HOSTS=dragonfly:dragonfly:6379
      - HTTP_USER=admin
      - HTTP_PASSWORD=admin
    depends_on:
      dragonfly:
        condition: service_healthy
      # redis:
      #   condition: service_healthy
    networks:
      - healthcare-network
    restart: unless-stopped

  worker:
    build:
      context: ../..
      dockerfile: devops/docker/Dockerfile.dev
    container_name: healthcare-worker
    environment:
      # Application Environment
      NODE_ENV: development
      APP_MODE: worker
      SERVICE_NAME: worker
      DOCKER_ENV: "true"
      
      # Database Configuration
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/userdb?connection_limit=50&pool_timeout=20
      PRISMA_SCHEMA_PATH: /app/src/libs/infrastructure/database/prisma/schema.prisma
      
      # Cache Provider Configuration (Dragonfly is default)
      CACHE_ENABLED: "true"
      CACHE_PROVIDER: dragonfly
      DRAGONFLY_ENABLED: "true"
      DRAGONFLY_HOST: dragonfly
      DRAGONFLY_PORT: 6379
      DRAGONFLY_KEY_PREFIX: "healthcare:"
      
      # JWT Configuration (for queue operations)
      JWT_SECRET: dev-jwt-secret-key-change-in-production
      
      # BullMQ Worker Configuration
      BULL_WORKER_CONCURRENCY: "5"
      BULL_MAX_JOBS_PER_WORKER: "100"
      
      # Logging Configuration
      LOG_LEVEL: debug
      ENABLE_AUDIT_LOGS: "true"
    volumes:
      - ../../:/app
      - /app/node_modules
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
      api:
        condition: service_started
    networks:
      - healthcare-network
    restart: unless-stopped
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        until pg_isready -h postgres -p 5432 -U postgres; do
          echo 'Waiting for postgres...'
          sleep 2
        done &&
        echo 'Database is ready!' &&
        echo 'Generating Prisma Client...' &&
        pnpm prisma generate --schema=./src/libs/infrastructure/database/prisma/schema.prisma || echo 'Prisma generate completed' &&
        echo 'Starting worker process...' &&
        pnpm exec ts-node -r tsconfig-paths/register src/worker-bootstrap.ts
      "

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: healthcare-pgadmin
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "True"
      # PGADMIN_CONFIG_LOGIN_BANNER: "Welcome to Healthcare Database Management"  # Commented out due to syntax error
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - healthcare-network
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost/misc/ping').read()\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped

  # Jitsi Meet Services
  jitsi-prosody:
    image: jitsi/prosody:latest
    container_name: healthcare-jitsi-prosody
    environment:
      - AUTH_TYPE=internal
      - ENABLE_AUTH=1
      - ENABLE_GUESTS=1
      - GUEST_DOMAIN=guest.localhost
      - XMPP_DOMAIN=localhost
      - XMPP_AUTH_DOMAIN=auth.localhost
      - XMPP_GUEST_DOMAIN=guest.localhost
      - XMPP_MUC_DOMAIN=muc.localhost
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.localhost
      - XMPP_RECORDER_DOMAIN=recorder.localhost
      - JICOFO_COMPONENT_SECRET=dev-jicofo-secret-change-in-production
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=dev-focus-password-change-in-production
      - JVB_AUTH_PASSWORD=dev-jvb-password-change-in-production
      - JIGASI_XMPP_PASSWORD=dev-jigasi-password-change-in-production
      - JIBRI_RECORDER_PASSWORD=dev-jibri-password-change-in-production
      - JIBRI_XMPP_PASSWORD=dev-jibri-xmpp-password-change-in-production
      - JWT_APP_ID=${JITSI_APP_ID:-healthcare-jitsi-app}
      - JWT_APP_SECRET=${JITSI_APP_SECRET:-dev-jitsi-secret-change-in-production}
      - JWT_ACCEPTED_ISSUERS=healthcare-jitsi-app
      - JWT_ACCEPTED_AUDIENCES=healthcare-jitsi-app
      - ENABLE_JWT=1
      - PUBLIC_URL=${JITSI_BASE_URL:-https://localhost:8443}
      - TZ=UTC
    volumes:
      - jitsi_prosody_config:/config
      - jitsi_prosody_plugins:/prosody-plugins-custom
    networks:
      - healthcare-network
    restart: unless-stopped

  jitsi-web:
    image: jitsi/web:latest
    container_name: healthcare-jitsi-web
    ports:
      - "8443:443"
      - "8080:80"
    environment:
      - ENABLE_AUTH=1
      - ENABLE_GUESTS=1
      - ENABLE_LETSENCRYPT=0
      - ENABLE_HTTP_REDIRECT=1
      - DISABLE_HTTPS=0
      - JICOFO_AUTH_USER=focus
      - XMPP_DOMAIN=localhost
      - XMPP_AUTH_DOMAIN=auth.localhost
      - XMPP_BOSH_URL_BASE=http://localhost:5280
      - XMPP_GUEST_DOMAIN=guest.localhost
      - XMPP_MUC_DOMAIN=muc.localhost
      - XMPP_RECORDER_DOMAIN=recorder.localhost
      - ENABLE_PREJOIN_PAGE=1
      - ENABLE_WELCOME_PAGE=1
      - ENABLE_CLOSE_PAGE=1
      - ENABLE_RECORDING=1
      - ENABLE_WAITING_ROOM=1
      - ENABLE_BREAKOUT_ROOMS=1
      - ENABLE_LOBBY=1
      - ENABLE_NOISY_MIC_DETECTION=1
      - ENABLE_TRANSCRIPTIONS=0
      - ENABLE_REMB=1
      - ENABLE_TCC=1
      - RESOLUTION=720
      - FRAME_RATE=30
      - CHANNEL_LAST_N=20
      - START_AUDIO_MUTED=10
      - START_VIDEO_MUTED=10
      - START_AUDIO_ONLY=0
      - DISABLE_DOMAIN_VERIFICATION=1
      - PUBLIC_URL=${JITSI_BASE_URL:-https://localhost:8443}
      - TZ=UTC
      - JWT_APP_ID=${JITSI_APP_ID:-healthcare-jitsi-app}
      - JWT_APP_SECRET=${JITSI_APP_SECRET:-dev-jitsi-secret-change-in-production}
      - JWT_ACCEPTED_ISSUERS=healthcare-jitsi-app
      - JWT_ACCEPTED_AUDIENCES=healthcare-jitsi-app
      - ENABLE_JWT=1
      - JWT_ASAP_KEYSERVER=${JITSI_BASE_URL:-https://localhost:8443}/asap
      - JWT_ALLOW_EMPTY=0
      - JWT_AUTH_TYPE=token
      - JWT_TOKEN_AUTH_MODULE=token_verification
    volumes:
      - jitsi_web_config:/config
      - jitsi_web_letsencrypt:/etc/letsencrypt
    depends_on:
      - jitsi-prosody
    networks:
      - healthcare-network
    restart: unless-stopped

  jitsi-jicofo:
    image: jitsi/jicofo:latest
    container_name: healthcare-jitsi-jicofo
    environment:
      - AUTH_TYPE=internal
      - ENABLE_AUTH=1
      - XMPP_DOMAIN=localhost
      - XMPP_AUTH_DOMAIN=auth.localhost
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.localhost
      - XMPP_SERVER=jitsi-prosody
      - JICOFO_COMPONENT_SECRET=dev-jicofo-secret-change-in-production
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=dev-focus-password-change-in-production
      - JICOFO_RESERVATION_REST_BASE_URL=
      - JVB_BREWERY_MUC=jvbbrewery
      - JIGASI_BREWERY_MUC=jigasibrewery
      - JIGASI_SIP_URI=
      - JIBRI_BREWERY_MUC=jibribrewery
      - JIBRI_PENDING_TIMEOUT=90
      - TZ=UTC
    volumes:
      - jitsi_jicofo_config:/config
    depends_on:
      - jitsi-prosody
    networks:
      - healthcare-network
    restart: unless-stopped

  jitsi-jvb:
    image: jitsi/jvb:latest
    container_name: healthcare-jitsi-jvb
    ports:
      - "10000:10000/udp"
      - "4443:4443"
    environment:
      - DOCKER_HOST_ADDRESS=127.0.0.1
      - XMPP_AUTH_DOMAIN=auth.localhost
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.localhost
      - XMPP_SERVER=jitsi-prosody
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=dev-jvb-password-change-in-production
      - JVB_BREWERY_MUC=jvbbrewery
      - JVB_PORT=10000
      - JVB_TCP_HARVESTER_DISABLED=true
      - JVB_TCP_PORT=4443
      - JVB_STUN_SERVERS=stun.l.google.com:19302,stun1.l.google.com:19302
      - JVB_ENABLE_APIS=rest,colibri
      - JVB_WS_DOMAIN=localhost
      - JVB_WS_SERVER_ID=
      - TZ=UTC
    volumes:
      - jitsi_jvb_config:/config
    depends_on:
      - jitsi-prosody
      - jitsi-jicofo
    networks:
      - healthcare-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

volumes:
  postgres_data:
    name: healthcare_postgres_data
  dragonfly_data:
    name: healthcare_dragonfly_data
  redis_data:
    name: healthcare_redis_data
  pgadmin_data:
    name: healthcare_pgadmin_data
  jitsi_prosody_config:
    name: healthcare_jitsi_prosody_config
  jitsi_prosody_plugins:
    name: healthcare_jitsi_prosody_plugins
  jitsi_web_config:
    name: healthcare_jitsi_web_config
  jitsi_web_letsencrypt:
    name: healthcare_jitsi_web_letsencrypt
  jitsi_jicofo_config:
    name: healthcare_jitsi_jicofo_config
  jitsi_jvb_config:
    name: healthcare_jitsi_jvb_config

networks:
  healthcare-network:
    name: healthcare_network
    driver: bridge

