FROM node:20-alpine AS development

LABEL app.component=backend
LABEL app.stage=development

RUN corepack enable && corepack prepare pnpm@9.15.4 --activate

RUN apk add --no-cache \
    postgresql-client \
    redis \
    busybox-extras \
    python3 \
    make \
    g++ \
    wget \
    curl \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# Copy package files first
COPY package.json pnpm-lock.yaml ./

# Install dependencies (skip postinstall since Prisma schema isn't available yet)
RUN pnpm install --frozen-lockfile --ignore-scripts

# Copy all source files (including Prisma schema and SWC configuration)
# .swcrc and nest-cli.json are required for SWC compiler (20x faster than tsc)
# Explicitly verify SWC config files are present (cross-platform compatibility)
COPY . .
RUN test -f .swcrc && test -f nest-cli.json && echo "[OK] SWC configuration files verified" || (echo "[ERROR] SWC config files missing!" && exit 1)

# Now generate Prisma client (schema is available)
# Run prisma generate directly (skip the copy script if it doesn't exist)
RUN pnpm prisma generate --schema=./src/libs/infrastructure/database/prisma/schema.prisma && \
    (test -f scripts/copy-prisma-to-pnpm.js && node scripts/copy-prisma-to-pnpm.js || echo "Copy script not found, skipping...") || true

ENV NODE_ENV=development
ENV PRISMA_SCHEMA_PATH=/app/src/libs/infrastructure/database/prisma/schema.prisma

EXPOSE 8088 5555

CMD ["pnpm", "start:dev"]

